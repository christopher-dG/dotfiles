#!/usr/bin/env sh

set -e

emacs="$HOME/.config/emacs"

case "$1" in
  "elixir")
    exls="$emacs/elixir-ls"

    if [[ ! -d "$exls" ]]; then
      git clone https://github.com/elixir-lsp/elixir-ls --branch v0.3.3 --depth 1 "$exls"
      cd "$exls"
      mix deps.get
      mix elixir_ls.release
    fi

    "$exls/release/language_server.sh"
    ;;

  "python")
    # Find a virtualenv for the project, or use a global one.
    cur="$2"
    venv="$emacs/pyls"
    while [[ "$cur" != "/" && "$cur" != "." ]]; do
      if [[ -f "$cur/venv/pyvenv.cfg" ]]; then
        venv="$cur/venv"
        break
      fi
      cur="$(dirname $cur)"
    done

    # Create the virtualenv if it doesn't exist, and activate it.
    [[ -d "$venv" ]] || python -m venv "$venv"
    source "$venv/bin/activate"

    # Install the language server if it's not already installed.
    if [[ ! -f "$venv/bin/pyls" ]]; then
      pip install "python-language-server[flake8,rope]" pyls-black pyls-mypy future
    fi

    pyls
    ;;
esac
